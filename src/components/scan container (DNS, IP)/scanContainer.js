import axios from "axios";
import { useEffect, useState } from "react";
import "./scanContainer.css";

function ScanContainer(props) {
  const apiKey =
    "6d88d7bd28bd02a2b84cdfa47fee9f343dd64eaed8d79022c10c527998b700e8";
  const [displayedContent, setDisplayedContent] = useState(
    props.content?.map((cont) => cont)
  );
  const [counter, setCounter] = useState(-1);

  async function getAnalysis(resourceType, resourceIdentifier, index) {
    try {
      const apiUrl = `https://www.virustotal.com/api/v3/${resourceType}/${resourceIdentifier}`;

      const response = await axios.get(apiUrl, {
        headers: {
          "x-apikey": apiKey,
        },
      });

      const newContent = displayedContent?.slice(0);
      //   console.log(newContent);
      newContent[index].states.harmless =
        response.data.data.attributes.last_analysis_stats.harmless;
      newContent[index].states.malicious =
        response.data.data.attributes.last_analysis_stats.malicious;
      newContent[index].states.suspicious =
        response.data.data.attributes.last_analysis_stats.suspicious;
      newContent[index].states.undetected =
        response.data.data.attributes.last_analysis_stats.undetected;

      return newContent;
    } catch (err) {
      console.error(err);
    }
  }

  useEffect(() => {
    if (counter !== -1) {
      async function func() {
        try {
          console.log(props.title, props.content[counter].name, counter);
          const response = await getAnalysis(
            props.title,
            props.content[counter].name,
            counter
          );
          setDisplayedContent(response);
        } catch (err) {
          console.log(err);
        }
      }
      func();
    } else setDisplayedContent(props.content);
  }, [counter]);

  useEffect(() => {
    setCounter(-1);
  }, [props?.content]);

  return (
    <div className="suspicious-container">
      <ul>
        {counter !== -1
          ? displayedContent?.map((cont, i) => (
              <li
                className="item"
                key={i}
                onClick={() => {
                  setCounter(i);
                }}
              >
                {cont.name} &rarr; harmless:{" "}
                <span>{cont.states?.harmless}</span>, malicious:{" "}
                <span>{cont.states?.malicious}</span>, suspicious:{" "}
                <span>{cont.states?.suspicious}</span>, undetected:{" "}
                <span>{cont.states?.undetected}</span>.
              </li>
            ))
          : props.content?.map((cont, i) => (
              <li
                className="item"
                key={i}
                onClick={() => {
                  setDisplayedContent(props?.content);
                  setCounter(i);
                }}
              >
                {cont.name} &rarr; harmless:{" "}
                <span>{cont.states?.harmless}</span>, malicious:{" "}
                <span>{cont.states?.malicious}</span>, suspicious:{" "}
                <span>{cont.states?.suspicious}</span>, undetected:{" "}
                <span>{cont.states?.undetected}</span>.
              </li>
            ))}
      </ul>
    </div>
  );
}

export default ScanContainer;
